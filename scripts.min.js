const $=window.$;window.version=`Archaeus Beta 2 (2.0.0-b2)`,window.compats={},window.ending=!1,window.firstMove=!0;function clamp(b,c=0,d=1){return Math.min(d,Math.max(b,c))}function titleCase(b){return b.toLowerCase().split(' ').map(c=>{return c[0].toUpperCase()+c.substr(1)}).join(' ')}function randInt(b,c){return Math.round(Math.random()*(c-b)+b)}function genBoard(b=void 0){window.left=window.storage.mines;for(let c=0;c<window.storage.mines;c++){let d,f,g;do d=randInt(0,window.storage.width-1),f=randInt(0,window.storage.height-1),g=$('#mainBoard tbody tr').eq(f).find('td').get(d);while(g.dataset.mine||g===b);g.dataset.mine='regular'}}function prepBoard(){$('#mainBoard thead tr td').attr('colspan',window.storage.width),$('#flags span').text(window.storage.mines),$('#flags img').click(()=>{toggleOverlay()}),$('#reset img').click(()=>{window.location.reload()}),$('#mainBoard tbody').html(`<tr>${'<td class="cell" data-shown="false" data-flagged="default"></td>'.repeat(window.storage.width)}</tr>`.repeat(window.storage.height)),$('.cell').mousedown(b=>{1===b.which?(!window.start&&(window.start=new Date),window.firstMove&&(genBoard(b.target),window.firstMove=!1),revealCell(b.target)):3===b.which&&flagCell(b.target),$('[data-flagged="flagged"][data-mine]').length===parseInt(window.storage.mines)&&winGame()}).contextmenu(()=>{return!1})}function shakeBoard(b=5,c=0.5){let d=100;for(let f=0;f<d;f++)setTimeout(()=>{$('#mainBoard').css('transform',`translate(${randInt(0,b)}px, ${randInt(0,b)}px)`)},10*(f*c));setTimeout(()=>{$('#mainBoard').css('transform','translate(0px, 0px)')},10*((d+1)*c))}async function endGame(){window.ending=!0,$('.cell:not([data-shown="true"])').each((b,c)=>{revealCell(c)}),svgBombColor()}async function loseGame(){window.ending||('true'===window.storage.explodeShake&&shakeBoard(),endGame(),$('#reset img').attr('src','images/face-dead.svg'))}async function winGame(){window.ending||(endGame(),$('#reset img').attr('src','images/face-cool.svg'))}function coordsToCell(b,c){return $('#mainBoard tbody tr').eq(c).find('td').get(b)}function cellToCoords(b){return[$(b).index(),$(b).parent().index()]}function getAdjacent(b){let c=cellToCoords(b),d=c[0],f=c[1],g=clamp(d-1,0,window.storage.width-1),h=clamp(d+1,0,window.storage.width-1),j=clamp(f-1,0,window.storage.height-1),k=clamp(f+1,0,window.storage.height-1),l=[];for(let n=j;n<=k;n++)for(let o=g;o<=h;o++)l.push(coordsToCell(o,n)),d===o&&f===n&&l.pop();return l}function calcNear(b){let c=0;for(let d of getAdjacent(b))d.dataset.mine&&(c+=1);return c}async function revealCell(b){if('flagged'===b.dataset.flagged&&!window.ending)return!1;if(b.dataset.shown=window.ending&&'true'===window.storage.postShown?'post':'true',b.dataset.mine)svgAdd(b),window.ending?'detonated'!==b.dataset.mine&&(b.dataset.mine=b.dataset.flagged):(b.dataset.mine='detonated',loseGame());else{let c=calcNear(b);if(b.dataset.near=c,0===c)for(let d of getAdjacent(b))'false'===d.dataset.shown&&revealCell(d);else'flagged'!==b.dataset.flagged&&(b.innerText=c)}(window.ending&&b.dataset.mine||!window.ending||'guessed'===b.dataset.flagged)&&flagCell(b,0)}function flagCell(b,c=void 0){let d=['default','flagged','guessed'],f=d.indexOf(b.dataset.flagged),g=c===void 0?(f+1)%3:c;return'false'!==b.dataset.shown&&void 0===c||0>window.left-1&&0===f?!1:void(b.dataset.flagged=d[g],!window.ending&&(window.left=window.storage.mines-$('[data-flagged="flagged"]').length),$('#flags span').text(window.left).get(0).title=`${$('[data-flagged="flagged"]').length} Marked\n${$('[data-flagged="guessed"]').length} Guess(es)`)}async function svgAdd(b){b.innerHTML=`<svg width="24" height="24" viewBox="0 0 24 24">${'<path d="M11.25,6A3.25,3.25 0 0,1 14.5,2.75A3.25,3.25 0 0,1 17.75,6C17.75,6.42 18.08,6.75 18.5,6.75C18.92,6.75 19.25,6.42 19.25,6V5.25H20.75V6A2.25,2.25 0 0,1 18.5,8.25A2.25,2.25 0 0,1 16.25,6A1.75,1.75 0 0,0 14.5,4.25A1.75,1.75 0 0,0 12.75,6H14V7.29C16.89,8.15 19,10.83 19,14A7,7 0 0,1 12,21A7,7 0 0,1 5,14C5,10.83 7.11,8.15 10,7.29V6H11.25M22,6H24V7H22V6M19,4V2H20V4H19M20.91,4.38L22.33,2.96L23.04,3.67L21.62,5.09L20.91,4.38Z" />'}</svg>`,'false'!==b.dataset.shown&&$(b).css('padding','0px')}async function svgBombColor(){$('[data-mine]').each((b,c)=>{$(c).find('svg path').attr('fill',window.storage[`bomb${titleCase(c.dataset.mine)}`])})}function defaultSettings(){window.difficulty={beginner:()=>{window.storage.mines=10,window.storage.width=8,window.storage.height=8,window.location.reload()},intermediate:()=>{window.storage.mines=40,window.storage.width=16,window.storage.height=16,window.location.reload()},expert:()=>{window.storage.mines=99,window.storage.width=30,window.storage.height=16,window.location.reload()}},parseInt(window.storage.mines)||window.difficulty.intermediate(),window.storage.bombDefaultDefault='#000000',window.storage.bombDetonatedDefault='#FF1300',window.storage.bombFlaggedDefault='#008100',window.storage.bombGuessedDefault='#000083',window.storage.bombDefault=window.storage.bombDefault||window.storage.bombDefaultDefault,window.storage.bombDetonated=window.storage.bombDetonated||window.storage.bombDetonatedDefault,window.storage.bombFlagged=window.storage.bombFlagged||window.storage.bombFlaggedDefault,window.storage.bombGuessed=window.storage.bombGuessed||window.storage.bombGuessedDefault,window.storage.postShown=window.storage.postShown||!1,window.storage.explodeShake=window.storage.explodeShake||!1}async function prepSettings(){$('#mainSettings').css({width:$('#mainBoard tbody').width()-4,height:$('#mainBoard tbody').height()-4,top:1.5*$('#mainBoard').offset().top+$('#mainBoard thead').outerHeight()}),$('#icons-demo [data-mine]').each((b,c)=>{svgAdd(c)}).mousedown(function(b){let c=`bomb${titleCase(this.dataset.mine)}`;1===b.which?$(`[data-storage-value="${c}"]`).get(0).click():3===b.which&&(window.storage[c]=window.storage[`${c}Default`],this.value=window.storage[c],svgBombColor())}).contextmenu(()=>{return!1}),$('[name="inp-mines"]').change(b=>{b.target.value=clamp(b.target.value,1,window.storage.width*window.storage.height-1),window.storage.mines=b.target.value}).get(0).value=window.storage.mines,$('[data-storage-value]').each((b,c)=>{'checkbox'===c.type?c.checked='true'===window.storage[c.dataset.storageValue]:c.value=window.storage[c.dataset.storageValue]}).change(b=>{window.storage[b.target.dataset.storageValue]='checkbox'===b.target.type?b.target.checked:b.target.value,svgBombColor()}),$('#icons-demo').append(window.compats.color?'<span class="sm">Click the bombs to change their colors</span>':''),$('#misc-demo').append(`<br><span class="sm">Version ${window.version}</span>`)}function toggleOverlay(){$('[data-toggle]').get(0).dataset.toggle='false'===$('[data-toggle]').get(0).dataset.toggle}function checkCompat(){try{let b=document.createElement('input');b.type='color',window.compats.color=!0}catch(b){window.compats.color=!1}try{window.storage=window.localStorage,window.compats.storage=!0}catch(b){window.storage={},window.compats.storage=!1}}function load(){checkCompat(),defaultSettings(),prepBoard(),prepSettings(),svgBombColor(),setInterval(()=>{if(window.start&&!window.ending){let b,c,d,f;b=new Date-window.start,c=Math.floor(b/1e3/60/60),b-=60*(60*(1e3*c)),d=Math.floor(b/1e3/60),b-=60*(1e3*d),f=Math.floor(b/1e3),$('#timer').text(`${c.toString().padStart(2,'0')}:${d.toString().padStart(2,'0')}:${f.toString().padStart(2,'0')}`)}},1e3)}load();
